# Vercel Deploy: Revalidation works poorly on pages that are cached in prerendering during build time

Deploy the project to Vercel and set this environment variables:

Env | Purpose | Example |
--- | --- | --- |
NEXT_PUBLIC_SITE_URL | Necessary for internal api fetch | https://nextjs-revalidation-test.vercel.app | 
CACHE_METHOD | Determines the cache method | `fetch` or `fetch_isr` or `unstable_cache` or `unstable_cache_isr` | 
RENDER_LOG | Display custom logs in dashboard or console | `"true"` or `"false"` | 

Runtime logs that are generated by RENDER_LOG are formatted like this: "### --- HH:mm:ss --- Log Text" and can be found here in vercel account : dashboard / Logs.
If you see "Global Cache: api-error" on website it is because the internal api was not ready during build so deploy it again and it should be ok.

## 1 - Behavior with fetch and `cache: "force-cache"` (CACHE_METHOD = "fetch"):

1. Click on "dynamic", go to dynamic page (it is dynamically rendered). You should see something like "Global Cache: <266> 12-07 07:46:03". This value is what we expect to see in all of the pages (e.g., /static/01) **[Side issue #1]**.
2. Navigate to all other pages including "params/01" to "params/06" to make sure they are rendered and cached.
3. Click on "Control Panel". Then click on `revalidatePath("/", "layout")` **[Side issue #2]**.
4. Click on "dynamic" again. You will see new global cache in dynamic page. You should see some logs like this in dashboard as well:

\### --- 08:24:58 --- Called get-number api <730> 12-07 08:24:58

\### --- 08:26:09 --- Rendered dynamic page.tsx
  
6. Go to other static pages and param pages. Notice pages that were previously cached during build process, have a hard time revalidating and you won"t see a log pointing "Rendered page.tsx". Hence "/params/01" and "/params/02" will still show old data because they are rendered using `generateStaticParams()`. but other params (e.g. /params/03) will render (with proper logs) and show fresh data.
7. In this stage if you somehow can cause a new render in those pages, they will revalidate and cache alright from this point forward (with proper logs). The workaround is you go to that page and hit hard reloads (ctrl + R). Keep in mind soft navigation and `router.refresh()` won't cause a new render in this stage. If you are lucky enough, you can get one or two new renders in every step, then you click on `revalidatePath("/", "layout")` again and repeat the process until you clean all of the pages **[side issue #3]**.

## 2 - Behavior with isr fetch (CACHE_METHOD = "fetch_isr"):

1. Same as 2.1
2. Same as 2.2
3. Same as 2.3
4. Same as 2.4
5. Most pages will render again proprerly here.
6. If a page is still serving old data one hard reload (ctrl + R) will cause a new render but keep in mind you will still see the stale page until next reload or soft navigation or `router.refresh()` [side issue #3].
7.For isr pages that have `prefetch = false` including "isr 10s" and "isr 2h", first time navigating will cause a new render but new data will always be served in next visit [side issue #3]. This behavior is extremely intense in "isr 10s" page.

## 3- Behavior with unstable_cache and isr (CACHE_METHOD = "unstable_cache_isr"):

1. Nextjs spam calls unstable_cache multiple times during build and revalidation calls are duplicate. Some fixes that applied on fetch should be apply to unstable_cache as well.
2. Sometimes some random renders happen.
3.  Also, it seems unstable_cache is returning different result to different pages at the same time.
4. ...

## Side issue #1 (cache is not consistence during build on vercel)
Sometimes Global Cache for prerendered pages during build process is not consistence between different page. Most of the times they serve a new and updated global cache while global cache shown in dynamic page is the same from the previous build.

## Side issue #2 (Calling revalidatePath in a server action causes unnecessary render on the current page)
. This happens in local build as well. Control panel will render once which will be lost and will not be cached. Next time you visit control panel you might still get old data or a different set of data. For this issue in local build, you can call revalidatePath(custom) and keep an eye on different values under "Page Specific" section in control panel (also keep in mind react, renders each page two times, one for hard reload and one for RSC and soft navigation).

## Side issue #3 (app router serves stale data despite rendering fresh pages)
When attempting to revalidate with hard reloads. If you are lucky and caused a new render, at that specific hit you still get the stale data while you see the render log in the dashboard. Only After next reload or soft navigation or `router.refresh()` new rendered page will be served.

## Issue 4 (can't revalidate not found page)

1. Go to "Control Panel" click on the "root layout" button.
2. Click on "not found" button on navbar or type in any arbitrary address.
3.1. (On Vercel) general not found page always returns stale data.
3.2. (On local build) not found page is a dynamic page.

## Issue 5 (cached notfound())

1. Type in any non-numeric ids like /params/gg to /params/njs.

2. Pages that use notFound() from next/navigation are actually cached.

3. This could cause Disk exhaustion.

4. notFound() should always redirect to one general not found page.

5. Or implement a garbage collector mechanism with Maximum cache size and maximum cache age that purges oldest visited page.

6. With this behavior regular pages with params will also be generated and cached without proper control.

This is a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).


## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.
